<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Scraps of Code | A front end dev blog</title>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <!-- Load a favicon-->
    <link rel="shortcut icon" href="./assets/img/favicons/favicon.ico"/>
    <!-- Load font icons-->
    <!-- Material Design Iconic Font - (http://zavoloklom.github.io/material-design-iconic-font/index.html)-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/material-design-iconic-font/2.2.0/css/material-design-iconic-font.min.css"/>
    <!-- Load Google Fonts-->
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,700,700i" rel="stylesheet"/>
    <!-- Load the main stylesheet-->
    <link rel="stylesheet" href="assets/css/main.css"/>
  </head>
  <body>
    <div id="app">
      <div id="masthead">
        <div class="section-inner">
          <div class="title"><a class="masthead-link" href="https://brianhaferkamp.github.io/scrapsofcode/">
              <h1 class="masthead-title">Scraps of Code</h1></a>
            <h2 class="masthead-subtitle">A front end dev blog</h2>
          </div>
          <div class="feed"><a class="feed-link" href="http://fetchrss.com/rss/5d0bafa78a93f8e02e8b45675d0baf7f8a93f8ad2c8b4567.xml" target="_blank"><i class="zmdi zmdi-rss"></i> RSS Feed</a></div>
        </div>
      </div>
      <section id="stories">
        <div class="stories-inner">
          <!-- header
          h3.page-headline Today
          
          -->
          <div class="stories-group">
            <h4 class="stories-group-date">July 12, 2019</h4>
            <h3 class="stories-group-headline">Adding a Service Worker to Your Web Site</h3>
            <section class="stories-image"><img src="assets/img/no-connection.png" alt="A blue circle with a Wi-Fi signal and a line crossed through it representing no network connection"/></section>
            <article class="stories-group-content">
              <p>Yesterday I talked up the benefits of using service workers for your website. Today I'm going to show you how to add a service worker to your website.</p>
              <p>The first step is to set up a new JavaScript file. Most people name it <code>sw.js</code> or <code>service-worker.js</code>. You want to put this in the root of your project (the same level as your <code>index.html</code> file).</p>
              <p>Next, you need to add the following code to the top of your main JavaScript file:</p>
              <p>
                <pre><code>// Check the browser to make sure it supports service workers

if('serviceWorker' in navigator) {
navigator.serviceWorker

  // Register the path to the service worker file
  .register('./sw.js')

  .then(function() { console.log("Service Worker Registered"); });
}
</code></pre>
              </p>
              <p>This is taken from Google's Service workers fundamentals page, so you can read more about what the code is doing there. For now, just know that this checks to see if the browser supports service workers and then registers your service worker file (sw.js) once the page loads. If the service worker registration is successful, it is logged to the console. Any errors are also logged to the console.</p>
              <p>Now that our main JavaScript file is registering our service worker code, let's turn our attention to our service worker file. The first thing we need to do is set up our cache and all the files we want to cache. Add this code to the top of your sw.js file:</p>
              <p>
                <pre><code>//-----------------------------------------
// Service Worker
//
// * Offline first
// * Clears old cache on version change
//
//-----------------------------------------

// Init cache name/version
const cacheName = 'v1';

// which pages/assets do you want to cache?
const cacheAssets = [

  'index.html',
  'assets/css/main.css',
  'assets/js/app.js'

]
</code></pre>
              </p>
              <p>The first thing we need to do is set up our the name of our cache. This will allow us to update the cache when we make changes to the cached files. Second, we set up an array that holds all of our cached files. You'll set all of the assets you want to cache. There are only files here in this example, but you can also cache images. Just put the path to each image you want to cache.</p>
              <p>The next piece of code we need to add to sw.js is the code that installs the service worker. Add this code after our cache setup:</p>
              <p>
                <pre><code>// Install service worker

self.addEventListener('install', (e) => {

  console.log('Service Worker: Installed');

  e.waitUntil(
    caches
      .open(cacheName)
      .then(cache => {
        console.log('Service Worker: Caching Files');
        cache.addAll(cacheAssets);
      })

      .then(() => self.skipWaiting())
  );
});
</code></pre>
              </p>
              <p>There are several parts to the <a href="https://developers.google.com/web/fundamentals/primers/service-workers/lifecycle" target="_blank">service worker life cycle</a>. This boilerplate code includes three, specifically: Install, Activate, and Fetch.</p>
              <p>The code above installs the service worker the first time the user visits the site. What does installation mean? It means the service worker is installed in the browser and starts working. In the code above, a new cache is opened with the <code>cacheName</code> variable we set at the top of the file. After the cache is opened, we add all of our files in the <code>cacheFiles</code> array to the opened cache.</p>
              <p>Activating the service worker is our next step. We add the following code after the install event:</p>
              <p>
                <pre><code>// Activate the service worker

self.addEventListener('activate', (e) => {
  console.log('Service Worker: Activated');

  // Remove old caches
  e.waitUntil(

    caches.keys().then(cacheNames => {

      return Promise.all(

        // look at all the cacheNames
        cacheNames.map(cache => {

          // if the current cache !== cacheName then delete it
          if (cache !== cacheName) {
            console.log('Service Worker: Clearing Old Cache');
            return caches.delete(cache);
          }
        })
      )
    })
  );

});
</code></pre>
              </p>
              <p>Once the service worker is activated, it will make sure that the cache is updated. It loops through all the cache names to see if the <code>cacheName</code> variable is equal to the variable at the top of the service worker file. If it is not then it will be deleted. This keeps the cached files updated when the user visits the site.</p>
              <p>The last piece of code is the Fetch event. This is what happens when the user requests a URL. Put this code after the activation code in your service worker file:</p>
              <p>
                <pre><code>// listen for fetch event (HTTP request)

self.addEventListener('fetch', (e) => {
  console.log('Service Worker: Fetching');

  // Offline as backup
  // e.respondWith(
  //   // if the user is online, perform a regular HTTP request
  //   fetch(e.request)
  //   // if the HTTP request fails (offline) then serve the assets requested from the cache
  //   .catch(() => caches.match(e.request))
  // )


  // Offline first (preferred)

  e.respondWith(

    // are the files requested in the cache already?
    caches.match(e.request).then(cachedResponse => {

      // if yes, then serve files from cache
      if (cachedResponse) {
        console.log('Found in cache!');
        return cachedResponse;
      }

      // else do an HTTP request to the server
      return fetch(e.request);
    })
  )
});
</code></pre>
              </p>
              <p>It is important to note that you have some patterns to work with. The pattern above sets up the service worker to intercept the browser's HTTP request (that would normally go to the server) with the service worker. It checks to see if the files being requested are already in the cache. If they are then the files are served to the browser from the cached files, not from the server. If there are files not in the cache, then the request goes to the server to get those files. This pattern is considered offline first because you do not need a network connection once the files are cached. If your entire site is cached, the user should still be able to browse the content without a network connection.</p>
              <p>You can see that there is also an offline as backup pattern. The HTTP request is made normally but if the user is offline or loses connectivity, you can serve an offline version of the website from the files in your cache. This allows users to have fresh content but fallback to predetermined content if the network fails. Google suggests using the offline model. There is also a pattern that allows you to grow the cache based on requests that are not found in the cache when the user makes a fetch request.</p>
              <p>The rabbit hole for service workers goes pretty deep but the code above will get you an offline first site where the user won't be able to tell any difference if they lose connectivity or have a poor connection. That is ultimately the goal with adding service workers to your site.</p>
              <p>Here is the full boilerplate code:</p>
              <p>
                <pre><code>//-----------------------------------------
// Service Worker
//
// * Offline first
// * Clears old cache on version change
//
//-----------------------------------------


//-----------------------------------------
// Init Cache
//-----------------------------------------

// Set cache name/version
const cacheName = 'v1';

// which pages/assets do you want to cache?
const cacheAssets = [
'index.html',
'assets/css/main.css',
'assets/js/app.js',
]


//-----------------------------------------
// Install service worker
//-----------------------------------------

self.addEventListener('install', (e) => {
  console.log('Service Worker: Installed');
  e.waitUntil(
    caches
      .open(cacheName)
      .then(cache => {
        console.log('Service Worker: Caching Files');
        cache.addAll(cacheAssets);
      })
      .then(() => self.skipWaiting())
  );
});


//-----------------------------------------
// Activate service worker (clear old cache)
//-----------------------------------------

self.addEventListener('activate', (e) => {
  console.log('Service Worker: Activated');

  // Remove old caches
  e.waitUntil(
    caches.keys().then(cacheNames => {
      return Promise.all(
        // look at all the cacheNames
        cacheNames.map(cache => {
          // if the current cache !== cacheName then delete it
          if (cache !== cacheName) {
            console.log('Service Worker: Clearing Old Cache');
            return caches.delete(cache);
          }
        })
      )
    })
  );

});


//-----------------------------------------
// Listen for fetch event (HTTP request)
//-----------------------------------------

self.addEventListener('fetch', (e) => {
  console.log('Service Worker: Fetching');

  //-----------------------------------------
  // Offline as backup
  // e.respondWith(
  //   // if the user is online, perform a regular HTTP request
  //   fetch(e.request)
  //   // if the HTTP request fails (offline) then serve the assets requested from the cache
  //   .catch(() => caches.match(e.request))
  // )

  //-----------------------------------------
  // Offline first
  e.respondWith(
    // are the files requested in the cache already?
    caches.match(e.request).then(cachedResponse => {
      // if yes, then serve files from cache
      if (cachedResponse) {
        console.log('Found in cache!');
        return cachedResponse;
      }
      // else do an HTTP request to the server
      return fetch(e.request);
    })
  )
});
</code></pre>
              </p>
              <p>Once you do all of the steps to add this to your code, your service worker should be up and running. Open your browser's dev tools, navigate to the "Application" tab and then select "Service Workers." If you installed the service worker correctly, this tab should show you the file name of your service worker, that it has been activated, and is currently running. It should look like the following:</p>
              <div class="stories-image"><img src="assets/img/service-worker-running.jpg"/></div>
              <p>To check your cached files, click on the arrow next to "Cache Storage" and then click on your cache. It should have the name you put into the <code>cacheName</code> variable at the top of your service worker file. You should be able to see all of the files that are in your <code>cacheAssets</code> array. Something like this:</p>
              <div class="stories-image"><img src="assets/img/service-worker-cache.jpg"/></div>
              <p>To check offline capability, check the "Offline" box and reload the page. You should see your site still served even if you are offline. Note that anything that requires a network connection to work (social media, YouTube, etc.) will not work in offline mode.</p>
              <p>And that's it! You now know how to build a basic service worker and create an offline experience for your users. Applying an offline first strategy for your site will also speed it up since the files requested are not coming all the way from the server. You should notice a big reduction in page load times&mdash;even if you only cache your home page, CSS, and JavaScript files.</p>
              <!-- AddThis Sharing--><div class="addthis_inline_share_toolbox"></div>
            </article>
          </div>
          <!-- Comments-->
          <footer class="comments">
            <header>
              <h4 class="comments-headline">Comments</h4>
              <p>Click the heart to show your appreciation. Click the Twitter bird to reply.</p>
              <div class="comment-tweet"></div>
            </header>
          </footer>
        </div>
      </section>
    </div>
    <!-- Loads jQuery (Delete if you're using vanilla JS)-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <!-- Loads app-specific JS-->
    <script src="./assets/js/app.js"></script>
    <!-- Load AddThis Code-->
    <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5cf11d30407c6e5a"></script>
  </body>
</html>